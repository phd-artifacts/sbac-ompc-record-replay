metadata:
  description: big matrix benchmark
  version: "1.0"
  runs: 1
  timeout: 1000
  retry: 1
  envvars: []

applications:
  big-matrix:
    command: >
      OMPCLUSTER_TASKBENCH_ITERATION_NUMBER={{ node_count+10 }}
      OMPCLUSTER_INITIAL_ITERATION_NUMBER={{ node_count}}
      OMPCLUSTER_INITIAL_SCHEDULE_POLICY=1
      OMPCLUSTER_RESCHEDULING_INTERVAL=0
      OMPCLUSTER_PRINTING_END_INIT=./application-output/matrix_node_{{ node_count}}
      mpirun -np {{ node_count }} -ppn 1 -hosts "{{ hosts }}"
      apptainer exec --nv sifs/improv-144.sif
      application/tb-tdg-no-loop/ompcluster/main
      -steps 64
      -type nearest
      -kernel load_imbalance
      -iter 1000000
      -width 64
      -imbalance 0.1

    capture:
      - type: all
        name: full_output

      - type: matches
        name: tb-time
        pattern: "Elapsed Time"
        lambda: >
          lambda x: (lambda m,e: float(m) * 10**int(e))(
          *x.split("Elapsed Time ")[1]
            .split(" seconds")[0]
            .strip()
            .lower()
            .split("e", 1)
          )

  simulator-matrix-feed:
    command: >
      SIMU_RR={{node_count}}
      SIMU_MATRIX=./application-output/matrix_node_{{ node_count}}_0
      apptainer exec --nv sifs/improv-144.sif
      application/taskgraph_experiments/simulator

    capture:
      - type: all
        name: full_output

benchmarks:
  big-matrix:
    node_count : [1,2,4]
  simulator-matrix-feed:
    node_count : [1,2,4]